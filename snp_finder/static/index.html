<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SNP Visualization</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        #chromosome-container {
            width: 100%;
            height: 300px;
            background-color: #eee;
            border: 1px solid #ccc;
            margin-top: 50px;
            overflow: hidden;
        }

        /* Default style for each SNP line */
        .snp-line {
            fill: red;
        }

        /* Additional classes for styling based on SNP type */
        .snp-high-quality {
            fill: green;
        }

        .snp-low-quality {
            fill: orange;
        }

        .snp-failed-filter {
            fill: gray;
        }

        /* Positioning the buttons at the top right corner */
        .top-right-buttons {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
        }

        /* Button styles */
        .button {
            padding: 10px 15px;
            background-color: #007bff;
            color: white;
            border: none;
            cursor: pointer;
            border-radius: 3px;
        }

        .dropdown {
            position: relative;
            display: inline-block;
        }

        .dropdown-content {
            display: none;
            position: absolute;
            background-color: #f9f9f9;
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
            z-index: 1;
        }

        .dropdown-content a {
            color: black;
            padding: 12px 16px;
            text-decoration: none;
            display: block;
        }

        .dropdown-content a:hover {
            background-color: #f1f1f1;
        }

        .dropdown:hover .dropdown-content {
            display: block;
        }
    </style>    
</head>
<body>
      <h1>SNP Visualization</h1>
    <!-- File input form -->
    <form id="file-path-form">
        <label for="bamFilePath">BAM File Path:</label><br>
        <input type="text" id="bamFilePath" name="bamFilePath"><br>
        <label for="referenceGenomePath">Reference Genome Path:</label><br>
        <input type="text" id="referenceGenomePath" name="referenceGenomePath"><br><br>
        <input type="button" value="Run Variant Caller" onclick="runVariantCaller()">
    </form>

    <div class="top-right-buttons">
        <button class="button" onclick="window.location.href='snp_table.html'">View SNP Details in Table</button>
        <div class="dropdown">
            <button class="button">Export Data</button>
            <div class="dropdown-content">
                <a href="#" onclick="exportData('csv')">Export as CSV</a>
                <a href="#" onclick="exportData('json')">Export as JSON</a>
            </div>
        </div>
    </div>

    <div id="zoom-controls" style="margin-bottom: 10px;">
       <label for="zoom-slider" style="font-weight: bold;">Zoom:</label>
        <input type="range" id="zoom-slider" min="1" max="60" step="0.1" value="1">
    </div>
    <div id="chromosome-container"></div>
    <div id="snp-details" style="margin-top: 20px; padding: 10px; border: 1px solid #ccc; background-color: #f9f9f9;">
        <h2>SNP Details</h2>
        <p>Click on a SNP to see more details here.</p>
    </div>
    
    <script>
        // Function to run the variant caller and fetch SNP data
        async function runVariantCaller() {
            const bamFilePath = document.getElementById('bamFilePath').value;
            const referenceGenomePath = document.getElementById('referenceGenomePath').value;

            const response = await fetch('/run_variant_caller', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    bam_file: bamFilePath,
                    reference_genome: referenceGenomePath
                })
            });

            const result = await response.json();

            if (response.ok) {
                fetchSnpData();  // Fetch and visualize SNP data
            } else {
                alert('Error: ' + result.error);
            }
        }

        // Function to fetch SNP data from the Flask backend
        async function fetchSnpData() {
            const response = await fetch('/get_snps');
            const snpData = await response.json();
            visualizeSnps(snpData);
        }

        function visualizeSnps(snps) {
            const container = d3.select("#chromosome-container");
            const width = container.node().clientWidth;
            const height = container.node().clientHeight;
            const maxPosition = Math.max(...snps.map(snp => parseInt(snp.position, 10)));

            const svg = container.append("svg")
                .attr("width", width)
                .attr("height", height);

            const g = svg.append("g");

            // Add SNP lines as SVG rectangles
            snps.forEach(snp => {
                const position = parseInt(snp.position, 10);
                const positionPercentage = (position / maxPosition) * width;

                const snpLine = g.append("rect")
                    .attr("x", positionPercentage)
                    .attr("y", 0)
                    .attr("width", 2)
                    .attr("height", height)
                    .attr("class", "snp-line");

                if (parseFloat(snp.quality) > 200) {
                    snpLine.classed("snp-high-quality", true);
                } else if (parseFloat(snp.quality) < 50) {
                    snpLine.classed("snp-low-quality", true);
                }

                if (snp.filter !== "." && snp.filter !== "PASS") {
                    snpLine.classed("snp-failed-filter", true);
                }

                snpLine.on("click", () => {
                    displaySnpDetails(snp);
                });
            });

            // Set up zoom behavior
            const zoom = d3.zoom()
                .scaleExtent([1, 10])
                .translateExtent([[0, 0], [width, height]])
                .on("zoom", function(event) {
                    g.attr("transform", event.transform);
                });

            svg.call(zoom);

            // Zoom slider control
            d3.select("#zoom-slider").on("input", function(event) {
                const zoomLevel = event.target.value;
                svg.transition().duration(100).call(zoom.scaleTo, zoomLevel);
            });
        }

        function displaySnpDetails(snp) {
            const detailsDiv = document.getElementById('snp-details');
            detailsDiv.innerHTML = `
                <h2>SNP Details</h2>
                <p><strong>Position:</strong> ${snp.position}</p>
                <p><strong>Reference:</strong> ${snp.reference}</p>
                <p><strong>Variant:</strong> ${snp.variant}</p>
                <p><strong>Quality:</strong> ${snp.quality}</p>
                <p><strong>Filter:</strong> ${snp.filter}</p>
                <p><strong>Info:</strong> ${snp.info}</p>
            `;
        }

        function exportData(format) {
            fetch('/get_snps')
                .then(response => response.json())
                .then(snps => {
                    let dataStr;
                    let mimeType;

                    if (format === 'csv') {
                        mimeType = 'text/csv';
                        dataStr = "data:text/csv;charset=utf-8," + convertToCSV(snps);
                    } else if (format === 'json') {
                        mimeType = 'application/json';
                        dataStr = "data:application/json;charset=utf-8," + encodeURIComponent(JSON.stringify(snps));
                    }

                    const downloadAnchor = document.createElement('a');
                    downloadAnchor.setAttribute('href', dataStr);
                    downloadAnchor.setAttribute('download', `snps.${format}`);
                    document.body.appendChild(downloadAnchor);
                    downloadAnchor.click();
                    downloadAnchor.remove();
                });
        }

        function convertToCSV(snps) {
            const headers = ["chromosome", "position", "reference", "variant", "quality", "filter", "info"];
            const csvRows = snps.map(snp => headers.map(header => snp[header]).join(","));
            return headers.join(",") + "\n" + csvRows.join("\n");
        }
    </script>      
</body>
</html>
